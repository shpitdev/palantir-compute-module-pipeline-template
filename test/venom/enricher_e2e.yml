name: Enricher Docker Compose E2E (Real Gemini)

vars:
  mock.url: http://127.0.0.1:18080
  input.rid: ri.foundry.main.dataset.11111111-1111-1111-1111-111111111111
  output.rid: ri.foundry.main.dataset.22222222-2222-2222-2222-222222222222
  token: dummy-token

testcases:

- name: docker_compose_e2e
  steps:
  - type: exec
    script: |
      set -eu
      cd "$(git rev-parse --show-toplevel)"
      mkdir -p test/artifacts/mock-foundry/uploads
      docker compose -f docker-compose.test.yml down -v --remove-orphans || true
      # Ensure clean uploads dir even if previous runs left root-owned files.
      docker run --rm --network=host -v "$PWD/test/artifacts/mock-foundry/uploads:/uploads" alpine:3.20 sh -c 'rm -rf /uploads/*'
      docker build --network=host -f Dockerfile.mock-foundry -t palantir-compute-module-pipeline-search/mock-foundry:e2e .
      docker build --network=host -f Dockerfile -t palantir-compute-module-pipeline-search/enricher:e2e .
      VENOM_UID="$(id -u)" VENOM_GID="$(id -g)" docker compose -f docker-compose.test.yml up -d mock-foundry

  - type: exec
    script: |
      set -eu
      cd "$(git rev-parse --show-toplevel)"
      # Wait for mock-foundry to accept connections.
      for i in $(seq 1 50); do
        if curl -fsS {{.mock.url}}/__debug/health >/dev/null; then
          exit 0
        fi
        sleep 0.2
      done
      echo "mock-foundry did not become ready" >&2
      exit 1
    assertions:
    - result.code ShouldEqual 0

  - type: exec
    script: |
      set -eu
      cd "$(git rev-parse --show-toplevel)"
      VENOM_UID="$(id -u)" VENOM_GID="$(id -g)" docker compose -f docker-compose.test.yml run --rm enricher
    assertions:
    - result.code ShouldEqual 0

  - type: http
    method: GET
    url: "{{.mock.url}}/__debug/calls"
    assertions:
    - result.statuscode ShouldEqual 200
    - result.bodyjson.bodyjson0.Path ShouldEqual "/api/v2/datasets/{{.input.rid}}/branches/master"
    - result.bodyjson.bodyjson1.Path ShouldEqual "/api/v2/datasets/{{.input.rid}}/readTable"
    - result.bodyjson.bodyjson2.Path ShouldEqual "/stream-proxy/api/streams/{{.output.rid}}/branches/master/records"
    - result.bodyjson.bodyjson3.Path ShouldEqual "/api/v2/datasets/{{.output.rid}}/branches/master"
    - result.bodyjson.bodyjson4.Path ShouldEqual "/api/v2/datasets/{{.output.rid}}/readTable"
    - result.bodyjson.bodyjson5.Path ShouldEqual "/api/v2/datasets/{{.output.rid}}/transactions"
    - result.bodyjson.bodyjson6.Path ShouldEqual "/api/v2/datasets/{{.output.rid}}/files/enriched.csv/upload"
    vars:
      txn_id:
        from: result.bodyjson.bodyjson7.Path
        regex: "/api/v2/datasets/[^/]+/transactions/([^/]+)/commit"

  - type: http
    method: GET
    url: "{{.mock.url}}/__debug/calls"
    assertions:
    - result.statuscode ShouldEqual 200
    - result.bodyjson.bodyjson7.Path ShouldEqual "/api/v2/datasets/{{.output.rid}}/transactions/{{.txn_id}}/commit"

  - type: http
    method: GET
    url: "{{.mock.url}}/__debug/uploads"
    assertions:
    - result.statuscode ShouldEqual 200
    - result.bodyjson.bodyjson0.datasetRid ShouldEqual "{{.output.rid}}"
    - result.bodyjson.bodyjson0.filePath ShouldEqual "enriched.csv"
    - result.bodyjson.bodyjson0.sizeBytes ShouldBeGreaterThan 50

  - type: http
    method: GET
    url: "{{.mock.url}}/api/v2/datasets/{{.output.rid}}/readTable?format=CSV"
    headers:
      Authorization: "Bearer {{.token}}"
      Accept: text/csv
    assertions:
    - result.statuscode ShouldEqual 200
    - result.body ShouldContainSubstring "email,linkedin_url,company,title,description,confidence,status,error,model,sources,web_search_queries"
    - result.body ShouldContainSubstring "alice@example.com"
    - result.body ShouldContainSubstring "bob@corp.test"
    - result.body ShouldContainSubstring ",ok,,"
    - result.body ShouldNotContainSubstring ",error,\""

  - type: exec
    script: |
      set -eu
      cd "$(git rev-parse --show-toplevel)"
      csv_path="test/artifacts/mock-foundry/uploads/{{.output.rid}}/_committed/readTable.csv"
      test -f "${csv_path}"
      if tail -n +2 "${csv_path}" | grep -q ',error,'; then
        echo "committed output contains error rows:" >&2
        cat "${csv_path}" >&2
        exit 1
      fi
      if ! tail -n +2 "${csv_path}" | grep -q ',ok,'; then
        echo "committed output contains no successful rows:" >&2
        cat "${csv_path}" >&2
        exit 1
      fi
    assertions:
    - result.code ShouldEqual 0

  - type: exec
    script: |
      set -eu
      cd "$(git rev-parse --show-toplevel)"
      docker compose -f docker-compose.test.yml down -v --remove-orphans
    assertions:
    - result.code ShouldEqual 0
