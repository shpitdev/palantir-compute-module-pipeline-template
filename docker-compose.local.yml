# Local, user-driven harness run.
#
# Usage:
#  1. Place your input CSV at:
#       .local/mock-foundry/inputs/<INPUT_RID>.csv
#     where INPUT_RID is the "rid" for alias "input" in test/fixtures/alias-map.json.
#  2. Run:
#       ./dev run foundry-emulated
#
# Outputs will be written under:
#   .local/mock-foundry/uploads/<OUTPUT_RID>/<TXN_ID>/
services:
  mock-foundry:
    build:
      context: .
      dockerfile: Dockerfile.mock-foundry
    user: "${LOCAL_UID:-0}:${LOCAL_GID:-0}"
    environment:
      MOCK_FOUNDRY_ADDR: ":8080"
      MOCK_FOUNDRY_INPUT_DIR: "/data/inputs"
      MOCK_FOUNDRY_UPLOAD_DIR: "/data/uploads"
    volumes:
      - ./.local/mock-foundry/inputs:/data/inputs:ro
      - ./.local/mock-foundry/uploads:/data/uploads

  enricher:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      - mock-foundry
    environment:
      FOUNDRY_URL: "http://mock-foundry:8080"
      BUILD2_TOKEN: "/fixtures/token.txt"
      RESOURCE_ALIAS_MAP: "/fixtures/alias-map.json"
      GEMINI_API_KEY: "${GEMINI_API_KEY}"
      GEMINI_MODEL: "${GEMINI_MODEL:-gemini-2.5-flash}"
      GEMINI_BASE_URL: "${GEMINI_BASE_URL:-}"
      GEMINI_CAPTURE_AUDIT: "${GEMINI_CAPTURE_AUDIT:-true}"
      REQUEST_TIMEOUT: "${REQUEST_TIMEOUT:-2m}"
    volumes:
      - ./test/fixtures:/fixtures:ro
    command: ["foundry"]
