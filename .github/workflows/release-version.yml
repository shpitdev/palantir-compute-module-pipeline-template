name: release-version

on:
  workflow_run:
    workflows:
      - ci
    types:
      - completed

permissions:
  actions: write
  contents: write
  pull-requests: write

concurrency:
  group: release-version-main
  cancel-in-progress: false

jobs:
  bump-and-tag:
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'main' &&
      !contains(github.event.workflow_run.head_commit.message, '[skip ci]')
    runs-on: blacksmith-4vcpu-ubuntu-2404
    env:
      GH_TOKEN: ${{ github.token }}
      REPO: ${{ github.repository }}
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Configure git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Compute next patch version
        id: version
        run: |
          set -euo pipefail
          file="internal/version/version.go"
          current="$(sed -n 's/^const Current = "\([0-9]\+\.[0-9]\+\.[0-9]\+\)"$/\1/p' "${file}")"
          if [[ -z "${current}" ]]; then
            echo "failed to parse version from ${file}" >&2
            exit 1
          fi
          IFS='.' read -r major minor patch <<< "${current}"
          next="${major}.${minor}.$((patch + 1))"
          tag="v${next}"
          echo "current=${current}" >> "${GITHUB_OUTPUT}"
          echo "next=${next}" >> "${GITHUB_OUTPUT}"
          echo "tag=${tag}" >> "${GITHUB_OUTPUT}"

      - name: Skip if target tag already exists
        id: exists
        run: |
          set -euo pipefail
          if git ls-remote --exit-code --tags origin "refs/tags/${{ steps.version.outputs.tag }}" >/dev/null; then
            echo "tag_exists=true" >> "${GITHUB_OUTPUT}"
            echo "tag ${{ steps.version.outputs.tag }} already exists; skipping release bump."
          else
            echo "tag_exists=false" >> "${GITHUB_OUTPUT}"
          fi

      - name: Create release bump PR
        id: pr
        if: steps.exists.outputs.tag_exists != 'true'
        run: |
          set -euo pipefail
          next="${{ steps.version.outputs.next }}"
          branch="chore/release-v${next}-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          git switch -c "${branch}"

          sed -i "s/^const Current = \".*\"$/const Current = \"${next}\"/" internal/version/version.go
          git add internal/version/version.go
          git commit -m "chore(release): bump version to v${next} [skip ci]"

          git push --set-upstream origin "${branch}"

          pr_body="$(
            cat <<EOF
          Automated release bump after successful publish of main.

          - Previous version: v${{ steps.version.outputs.current }}
          - Next version: v${next}

          This PR is merged automatically.
          EOF
          )"

          pr_url="$(
            gh pr create \
              --repo "${REPO}" \
              --base main \
              --head "${branch}" \
              --title "chore(release): bump version to v${next} [skip ci]" \
              --body "${pr_body}"
          )"
          pr_number="${pr_url##*/}"

          echo "branch=${branch}" >> "${GITHUB_OUTPUT}"
          echo "number=${pr_number}" >> "${GITHUB_OUTPUT}"

      - name: Merge release PR
        if: steps.exists.outputs.tag_exists != 'true'
        run: |
          set -euo pipefail
          pr_number="${{ steps.pr.outputs.number }}"
          next="${{ steps.version.outputs.next }}"

          if ! gh pr merge "${pr_number}" --repo "${REPO}" --auto --squash --delete-branch --subject "chore(release): bump version to v${next} [skip ci]"; then
            gh pr merge "${pr_number}" --repo "${REPO}" --squash --delete-branch --subject "chore(release): bump version to v${next} [skip ci]"
          fi

      - name: Wait for merge commit
        id: merge
        if: steps.exists.outputs.tag_exists != 'true'
        run: |
          set -euo pipefail
          pr_number="${{ steps.pr.outputs.number }}"

          merge_sha=""
          for _ in $(seq 1 120); do
            merge_sha="$(gh pr view "${pr_number}" --repo "${REPO}" --json mergeCommit --jq '.mergeCommit.oid // empty')"
            if [[ -n "${merge_sha}" ]]; then
              break
            fi
            sleep 5
          done

          if [[ -z "${merge_sha}" ]]; then
            echo "timed out waiting for PR #${pr_number} to merge" >&2
            exit 1
          fi

          echo "sha=${merge_sha}" >> "${GITHUB_OUTPUT}"

      - name: Create release tag
        if: steps.exists.outputs.tag_exists != 'true'
        run: |
          set -euo pipefail
          tag="${{ steps.version.outputs.tag }}"
          sha="${{ steps.merge.outputs.sha }}"

          if git ls-remote --exit-code --tags origin "refs/tags/${tag}" >/dev/null; then
            echo "tag ${tag} already exists; nothing to do."
            exit 0
          fi

          git fetch --no-tags origin main
          git tag -a "${tag}" "${sha}" -m "Release ${tag}"
          git push origin "refs/tags/${tag}"

      - name: Trigger Foundry publish for release tag
        if: steps.exists.outputs.tag_exists != 'true'
        run: |
          set -euo pipefail
          tag="${{ steps.version.outputs.tag }}"
          gh workflow run publish-foundry.yml --repo "${REPO}" --ref "${tag}"

      - name: Workflow summary
        run: |
          set -euo pipefail
          {
            echo "## Automated Release Bump"
            echo ""
            echo "- Source workflow run: [${{ github.event.workflow_run.id }}](${{ github.event.workflow_run.html_url }})"
            echo "- Previous version: \`${{ steps.version.outputs.current }}\`"
            if [[ "${{ steps.exists.outputs.tag_exists }}" == "true" ]]; then
              echo "- Result: skipped (tag already existed)"
            else
              echo "- New version: \`${{ steps.version.outputs.next }}\`"
              echo "- Git tag: \`${{ steps.version.outputs.tag }}\`"
              echo "- PR: #${{ steps.pr.outputs.number }}"
            fi
          } >> "${GITHUB_STEP_SUMMARY}"
